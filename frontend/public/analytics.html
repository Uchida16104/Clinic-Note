<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Note - データ分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/light.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/shoelace-autoloader.js"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        sl-card {
            background-color: #ffffff !important;
        }
        sl-card::part(base) {
            background-color: #ffffff !important;
        }
        .bg-white, .bg-white * {
            background-color: #ffffff !important;
        }
        .card-body {
            background-color: #ffffff !important;
        }
        h1, h2, h3, h4, h5, h6, p, span, div, label, strong {
            color: #1f2937 !important;
        }
        .text-gray-600, .text-gray-700, .text-gray-800, .text-indigo-900 {
            color: #1f2937 !important;
        }
        .text-blue-500, .text-green-500, .text-purple-500 {
            color: inherit !important;
        }
        sl-card .text-3xl,
        sl-card .text-2xl,
        sl-card .text-lg,
        sl-card div,
        sl-card p,
        sl-card span,
        sl-card strong {
            color: #1f2937 !important;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
<div x-data="analyticsData()" x-init="init()" class="container mx-auto px-4 py-8">

    <!-- Header -->
    <div class="flex justify-between items-center mb-8" data-aos="fade-down">
        <div>
            <h1 class="text-4xl font-bold" x-text="translations[currentLang].title"></h1>
            <p class="mt-2" x-text="translations[currentLang].subtitle"></p>
        </div>
        <div class="flex gap-2">
            <sl-button-group label="Language">
                <sl-button @click="switchLanguage('ja')" :variant="currentLang === 'ja' ? 'primary' : 'default'">
                    <span class="iconify" data-icon="twemoji:flag-japan"></span>
                </sl-button>
                <sl-button @click="switchLanguage('en')" :variant="currentLang === 'en' ? 'primary' : 'default'">
                    <span class="iconify" data-icon="twemoji:flag-united-states"></span>
                </sl-button>
            </sl-button-group>
            <sl-button variant="default" @click="window.location.href='/dashboard.html'">
                <span class="iconify" data-icon="mdi:arrow-left"></span>
            </sl-button>
        </div>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="text-center py-12">
        <sl-spinner style="font-size: 3rem;"></sl-spinner>
        <p class="mt-4" x-text="translations[currentLang].loading"></p>
    </div>

    <!-- Charts -->
    <div x-show="!loading" class="space-y-8">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <div class="chart-container">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <div class="chart-container">
                <canvas id="frequencyChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <div class="chart-container">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="/analytics.js"></script>

<script>
function analyticsData() {
    return {
        currentLang: 'ja',
        loading: true,
        chartData: null,
        charts: {},
        translations: {
            ja: { totalAppointments: '総通院回数' },
            en: { totalAppointments: 'Total Appointments' }
        },
        async init() {
            await this.loadAnalytics();
            this.loading = false;
            this.$nextTick(() => {
                setTimeout(() => this.createCharts(), 100);
            });
        },
        async loadAnalytics() {
            this.chartData = {
                departments: ['内科', '外科'],
                departmentCounts: [5, 3],
                months: ['Jan', 'Feb'],
                monthlyCounts: [2, 6]
            };
        },
        destroyCharts() {
            Object.values(this.charts).forEach(c => c && c.destroy());
            this.charts = {};
        },
        createCharts() {
            if (!this.chartData) return;
            this.destroyCharts();

            const canvas1 = document.getElementById('departmentChart');
            if (!canvas1) return;
            const ctx1 = canvas1.getContext('2d');
            if (!ctx1) return;

            this.charts.department = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: this.chartData.departments,
                    datasets: [{
                        label: this.translations[this.currentLang].totalAppointments,
                        data: this.chartData.departmentCounts
                    }]
                }
            });

            const canvas2 = document.getElementById('frequencyChart');
            if (!canvas2) return;
            const ctx2 = canvas2.getContext('2d');
            if (!ctx2) return;

            this.charts.frequency = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: this.chartData.months,
                    datasets: [{
                        label: this.translations[this.currentLang].totalAppointments,
                        data: this.chartData.monthlyCounts
                    }]
                }
            });

            const canvas3 = document.getElementById('pieChart');
            if (!canvas3) return;
            const ctx3 = canvas3.getContext('2d');
            if (!ctx3) return;

            this.charts.pie = new Chart(ctx3, {
                type: 'pie',
                data: {
                    labels: this.chartData.departments,
                    datasets: [{
                        data: this.chartData.departmentCounts
                    }]
                }
            });
        }
    };
}
</script>
</body>
</html>
