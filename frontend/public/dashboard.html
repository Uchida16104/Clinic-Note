<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Note - ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/light.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/shoelace-autoloader.js"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <script src="/js/timezone-utils.js"></script>
    <style>
        sl-input::part(base), sl-textarea::part(base), sl-select::part(combobox) {
            background-color: #ffffff !important;
            border: 1px solid #d1d5db !important;
        }
        
        sl-input::part(input), sl-textarea::part(textarea) {
            background-color: #ffffff !important;
            color: #1f2937 !important;
        }
        
        sl-card {
            background-color: #ffffff !important;
        }
        
        sl-card::part(base) {
            background-color: #ffffff !important;
        }

        .bg-white, .bg-white * {
            background-color: #ffffff !important;
        }
        
        h1, h2, h3, h4, h5, h6, p, span, div, label, strong {
            color: #1f2937 !important;
        }
        
        .text-gray-600, .text-gray-700, .text-gray-800, .text-indigo-900 {
            color: #1f2937 !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <div x-data="dashboardData()" x-init="init()" class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8" data-aos="fade-down">
            <div>
                <h1 class="text-4xl font-bold text-gray-800" x-text="translations[currentLang].title"></h1>
                <p class="text-gray-700 mt-2">
                    <span x-text="translations[currentLang].subtitle"></span>
                    <sl-badge variant="success" pill x-show="syncStatus === 'synced'" class="ml-2">
                        <span class="iconify mr-1" data-icon="mdi:cloud-check"></span>
                        <span x-text="translations[currentLang].synced"></span>
                    </sl-badge>
                    <sl-badge variant="warning" pill x-show="syncStatus === 'syncing'" class="ml-2">
                        <span class="iconify mr-1" data-icon="mdi:cloud-sync"></span>
                        <span x-text="translations[currentLang].syncing"></span>
                    </sl-badge>
                </p>
            </div>
            <div class="flex gap-2">
                <sl-button-group label="Language">
                    <sl-button @click="switchLanguage('ja')" :variant="currentLang === 'ja' ? 'primary' : 'default'">
                        <span class="iconify" data-icon="twemoji:flag-japan"></span>
                    </sl-button>
                    <sl-button @click="switchLanguage('en')" :variant="currentLang === 'en' ? 'primary' : 'default'">
                        <span class="iconify" data-icon="twemoji:flag-united-states"></span>
                    </sl-button>
                </sl-button-group>
                <sl-button variant="neutral" @click="syncData()">
                    <span class="iconify" data-icon="mdi:sync"></span>
                </sl-button>
                <sl-button variant="danger" @click="logout()">
                    <span class="iconify" data-icon="mdi:logout"></span>
                </sl-button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" data-aos="fade-up">
            <sl-card class="cursor-pointer hover:shadow-xl transition-shadow" @click="window.location.href='/calendar.html'">
                <div class="text-center p-4" style="background-color: #ffffff !important;">
                    <span class="iconify text-6xl mb-4" data-icon="mdi:calendar" style="color: #10b981;"></span>
                    <h3 class="text-xl font-bold text-gray-800" x-text="translations[currentLang].calendar" style="color: #1f2937 !important;"></h3>
                </div>
            </sl-card>
            <sl-card class="cursor-pointer hover:shadow-xl transition-shadow" @click="window.location.href='/appointments.html'">
                <div class="text-center p-4" style="background-color: #ffffff !important;">
                    <span class="iconify text-6xl mb-4" data-icon="mdi:calendar-check" style="color: #3b82f6;"></span>
                    <h3 class="text-xl font-bold text-gray-800" x-text="translations[currentLang].appointments" style="color: #1f2937 !important;"></h3>
                </div>
            </sl-card>
            <sl-card class="cursor-pointer hover:shadow-xl transition-shadow" @click="window.location.href='/analytics.html'">
                <div class="text-center p-4" style="background-color: #ffffff !important;">
                    <span class="iconify text-6xl mb-4" data-icon="mdi:chart-line" style="color: #a855f7;"></span>
                    <h3 class="text-xl font-bold text-gray-800" x-text="translations[currentLang].analytics" style="color: #1f2937 !important;"></h3>
                </div>
            </sl-card>
            <sl-card class="cursor-pointer hover:shadow-xl transition-shadow" @click="showAddClinicDialog = true">
                <div class="text-center p-4" style="background-color: #ffffff !important;">
                    <span class="iconify text-6xl mb-4" data-icon="mdi:hospital-building" style="color: #3b82f6;"></span>
                    <h3 class="text-xl font-bold text-gray-800" x-text="translations[currentLang].addClinic" style="color: #1f2937 !important;"></h3>
                </div>
            </sl-card>
            <sl-card class="cursor-pointer hover:shadow-xl transition-shadow" @click="window.location.href='/settings.html'">
                <div class="text-center p-4" style="background-color: #ffffff !important;">
                    <span class="iconify text-6xl mb-4" data-icon="mdi:settings" style="color: #a855f7;"></span>
                    <h3 class="text-xl font-bold text-gray-800" x-text="translations[currentLang].settings" style="color: #1f2937 !important;"></h3>
                </div>
            </sl-card>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-8" data-aos="fade-up" data-aos-delay="200" style="background-color: #ffffff !important;">
            <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-800" style="color: #1f2937 !important;">
                <span class="iconify text-indigo-600 mr-2" data-icon="mdi:hospital-box"></span>
                <span x-text="translations[currentLang].clinicList"></span>
            </h2>

            <sl-alert x-show="clinics.length === 0" variant="primary" open>
                <span class="iconify slot-icon" data-icon="mdi:information"></span>
                <span x-text="translations[currentLang].noClinics"></span>
            </sl-alert>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="clinic in clinics" :key="clinic.id">
                    <sl-card style="background-color: #ffffff !important;">
                        <div class="p-4" style="background-color: #ffffff !important;">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-800" x-text="clinic.hospital_name" style="color: #1f2937 !important;"></h3>
                                <sl-badge variant="primary" x-text="clinic.department"></sl-badge>
                            </div>
                            <div class="space-y-2 text-sm text-gray-700" style="color: #1f2937 !important;">
                                <div class="flex items-start" x-show="clinic.diagnosis">
                                    <span class="iconify mr-2 mt-1" data-icon="mdi:medical-bag" style="color: #ef4444;"></span>
                                    <span x-text="clinic.diagnosis" style="color: #1f2937 !important;"></span>
                                </div>
                                <div class="flex items-start" x-show="clinic.medication">
                                    <span class="iconify mr-2 mt-1" data-icon="mdi:pill" style="color: #10b981;"></span>
                                    <span x-text="clinic.medication" style="color: #1f2937 !important;"></span>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2 flex-wrap">
                                <sl-button size="small" variant="primary" @click="selectClinicForAppointment(clinic)">
                                    <span class="iconify" data-icon="mdi:calendar-plus"></span>
                                </sl-button>
                                <sl-button size="small" variant="success" @click="editClinic(clinic)">
                                    <span class="iconify" data-icon="mdi:pencil"></span>
                                </sl-button>
                                <sl-button size="small" variant="danger" @click="deleteClinic(clinic.id)">
                                    <span class="iconify" data-icon="mdi:delete"></span>
                                </sl-button>
                            </div>
                        </div>
                    </sl-card>
                </template>
            </div>
        </div>

        <sl-dialog :open="showAddClinicDialog" @sl-request-close="showAddClinicDialog = false" :label="translations[currentLang].addClinicTitle">
            <form @submit.prevent="addClinic()" class="space-y-4">
                <sl-input 
                    x-model="newClinic.hospital_name" 
                    :label="translations[currentLang].hospitalName"
                    :placeholder="translations[currentLang].hospitalNamePlaceholder"
                    required>
                </sl-input>
                <sl-input 
                    x-model="newClinic.department" 
                    :label="translations[currentLang].department"
                    :placeholder="translations[currentLang].departmentPlaceholder"
                    required>
                </sl-input>
                <sl-textarea 
                    x-model="newClinic.diagnosis" 
                    :label="translations[currentLang].diagnosis"
                    :placeholder="translations[currentLang].diagnosisPlaceholder"
                    rows="3">
                </sl-textarea>
                <sl-textarea 
                    x-model="newClinic.medication" 
                    :label="translations[currentLang].medication"
                    :placeholder="translations[currentLang].medicationPlaceholder"
                    rows="3">
                </sl-textarea>
                <sl-button type="submit" variant="primary" class="w-full" :loading="loading">
                    <span x-text="translations[currentLang].save"></span>
                </sl-button>
            </form>
        </sl-dialog>

        <sl-dialog :open="showEditClinicDialog" @sl-request-close="showEditClinicDialog = false" :label="translations[currentLang].editClinicTitle">
            <form @submit.prevent="updateClinic()" class="space-y-4">
                <sl-input 
                    x-model="editClinicData.hospital_name" 
                    :label="translations[currentLang].hospitalName"
                    :placeholder="translations[currentLang].hospitalNamePlaceholder"
                    required>
                </sl-input>
                <sl-input 
                    x-model="editClinicData.department" 
                    :label="translations[currentLang].department"
                    :placeholder="translations[currentLang].departmentPlaceholder"
                    required>
                </sl-input>
                <sl-textarea 
                    x-model="editClinicData.diagnosis" 
                    :label="translations[currentLang].diagnosis"
                    :placeholder="translations[currentLang].diagnosisPlaceholder"
                    rows="3">
                </sl-textarea>
                <sl-textarea 
                    x-model="editClinicData.medication" 
                    :label="translations[currentLang].medication"
                    :placeholder="translations[currentLang].medicationPlaceholder"
                    rows="3">
                </sl-textarea>
                <sl-button type="submit" variant="success" class="w-full" :loading="loading">
                    <span x-text="translations[currentLang].update"></span>
                </sl-button>
            </form>
        </sl-dialog>

        <sl-dialog :open="showAppointmentDialog" @sl-request-close="showAppointmentDialog = false" :label="translations[currentLang].addAppointmentTitle">
            <form @submit.prevent="addAppointment()" class="space-y-4">
                <sl-input 
                    type="date" 
                    x-model="newAppointment.date" 
                    :label="translations[currentLang].appointmentDate"
                    required>
                </sl-input>
                <sl-input 
                    type="time" 
                    x-model="newAppointment.time" 
                    :label="translations[currentLang].appointmentTime">
                </sl-input>
                <sl-button type="submit" variant="success" class="w-full" :loading="loading">
                    <span x-text="translations[currentLang].save"></span>
                </sl-button>
            </form>
            
            <sl-alert x-show="appointmentSuccess" variant="success" :open="appointmentSuccess !== ''" closable @sl-after-hide="appointmentSuccess = ''" class="mt-4">
                <span class="iconify slot-icon" data-icon="mdi:check-circle"></span>
                <span x-text="appointmentSuccess"></span>
            </sl-alert>
            <sl-alert x-show="appointmentError" variant="danger" :open="appointmentError !== ''" closable @sl-after-hide="appointmentError = ''" class="mt-4">
                <span class="iconify slot-icon" data-icon="mdi:alert-circle"></span>
                <span x-text="appointmentError"></span>
            </sl-alert>
        </sl-dialog>
    </div>

    <script>
        function dashboardData() {
            return {
                currentLang: 'ja',
                loading: false,
                clinics: [],
                showAddClinicDialog: false,
                showEditClinicDialog: false,
                showAppointmentDialog: false,
                selectedClinic: null,
                newClinic: { hospital_name: '', department: '', diagnosis: '', medication: '' },
                editClinicData: { id: null, hospital_name: '', department: '', diagnosis: '', medication: '' },
                newAppointment: { date: '', time: '' },
                syncStatus: 'synced',
                syncInterval: null,
                appointmentSuccess: '',
                appointmentError: '',
                translations: {
                    ja: {
                        title: 'ダッシュボード',
                        subtitle: 'あなたの通院管理',
                        synced: '同期完了',
                        syncing: '同期中',
                        calendar: 'カレンダー',
                        appointments: '通院履歴',
                        analytics: 'データ分析',
                        addClinic: '病院を追加',
                        clinicList: '登録済み病院',
                        noClinics: '登録された病院がありません。病院を追加してください。',
                        addClinicTitle: '病院を追加',
                        editClinicTitle: '病院情報を編集',
                        hospitalName: '病院名',
                        hospitalNamePlaceholder: '例: ○○総合病院',
                        department: '診療科目',
                        departmentPlaceholder: '例: 内科',
                        diagnosis: '診断名',
                        diagnosisPlaceholder: '例: 高血圧',
                        medication: '服薬名',
                        medicationPlaceholder: '例: アムロジピン',
                        save: '保存',
                        update: '更新',
                        addAppointmentTitle: '通院日を追加',
                        appointmentDate: '通院日',
                        appointmentTime: '時間',
                        settings: '設定'
                    },
                    en: {
                        title: 'Dashboard',
                        subtitle: 'Your Clinic Management',
                        synced: 'Synced',
                        syncing: 'Syncing',
                        calendar: 'Calendar',
                        appointments: 'Appointments',
                        analytics: 'Analytics',
                        addClinic: 'Add Clinic',
                        clinicList: 'Registered Clinics',
                        noClinics: 'No clinics registered. Please add a clinic.',
                        addClinicTitle: 'Add Clinic',
                        editClinicTitle: 'Edit Clinic Information',
                        hospitalName: 'Hospital Name',
                        hospitalNamePlaceholder: 'e.g., General Hospital',
                        department: 'Department',
                        departmentPlaceholder: 'e.g., Internal Medicine',
                        diagnosis: 'Diagnosis',
                        diagnosisPlaceholder: 'e.g., Hypertension',
                        medication: 'Medication',
                        medicationPlaceholder: 'e.g., Amlodipine',
                        save: 'Save',
                        update: 'Update',
                        addAppointmentTitle: 'Add Appointment',
                        appointmentDate: 'Date',
                        appointmentTime: 'Time',
                        settings: 'Settings'
                    }
                },
                
                async init() {
                    const savedLang = localStorage.getItem('clinicNoteLang') || 'ja';
                    this.currentLang = savedLang;
                    
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        window.location.href = '/login.html';
                        return;
                    }
                    
                    if (!localStorage.getItem('basicAuthToken')) {
                        localStorage.setItem('basicAuthToken', btoa('admin:ClinicNote'));
                    }
                    
                    AOS.init({ duration: 1000, once: true });
                    await this.loadClinics();
                    this.startAutoSync();
                },
                
                switchLanguage(lang) {
                    this.currentLang = lang;
                    localStorage.setItem('clinicNoteLang', lang);
                },
                
                async loadClinics() {
                    try {
                        const API_URL = 'https://clinic-note-api.onrender.com';
                        const authToken = localStorage.getItem('authToken');
                        const basicAuthToken = localStorage.getItem('basicAuthToken');
                        
                        const response = await fetch(`${API_URL}/api/clinics`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'X-Basic-Auth': basicAuthToken
                            }
                        });
                        
                        if (response.ok) {
                            this.clinics = await response.json();
                            console.log('Loaded clinics:', this.clinics.length);
                        }
                    } catch (err) {
                        console.error('Load clinics error:', err);
                    }
                },
                
                async addClinic() {
                    this.loading = true;
                    
                    try {
                        const API_URL = 'https://clinic-note-api.onrender.com';
                        const authToken = localStorage.getItem('authToken');
                        const basicAuthToken = localStorage.getItem('basicAuthToken');
                        
                        const response = await fetch(`${API_URL}/api/clinics`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`,
                                'X-Basic-Auth': basicAuthToken
                            },
                            body: JSON.stringify(this.newClinic)
                        });
                        
                        if (response.ok) {
                            await this.loadClinics();
                            this.showAddClinicDialog = false;
                            this.newClinic = { hospital_name: '', department: '', diagnosis: '', medication: '' };
                            await this.syncData();
                        }
                    } catch (err) {
                        console.error('Add clinic error:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                editClinic(clinic) {
                    this.editClinicData = {
                        id: clinic.id,
                        hospital_name: clinic.hospital_name,
                        department: clinic.department,
                        diagnosis: clinic.diagnosis || '',
                        medication: clinic.medication || ''
                    };
                    this.showEditClinicDialog = true;
                },

                async updateClinic() {
                    this.loading = true;
                    
                    try {
                        const API_URL = 'https://clinic-note-api.onrender.com';
                        const authToken = localStorage.getItem('authToken');
                        const basicAuthToken = localStorage.getItem('basicAuthToken');
                        
                        const response = await fetch(`${API_URL}/api/clinics/${this.editClinicData.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`,
                                'X-Basic-Auth': basicAuthToken
                            },
                            body: JSON.stringify({
                                hospital_name: this.editClinicData.hospital_name,
                                department: this.editClinicData.department,
                                diagnosis: this.editClinicData.diagnosis,
                                medication: this.editClinicData.medication
                            })
                        });
                        
                        if (response.ok) {
                            await this.loadClinics();
                            this.showEditClinicDialog = false;
                            this.editClinicData = { id: null, hospital_name: '', department: '', diagnosis: '', medication: '' };
                            await this.syncData();
                        }
                    } catch (err) {
                        console.error('Update clinic error:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async deleteClinic(id) {
                    if (!confirm(this.currentLang === 'ja' ? '本当に削除しますか?' : 'Are you sure to delete?')) return;
                    
                    try {
                        const API_URL = 'https://clinic-note-api.onrender.com';
                        const authToken = localStorage.getItem('authToken');
                        const basicAuthToken = localStorage.getItem('basicAuthToken');
                        
                        const response = await fetch(`${API_URL}/api/clinics/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'X-Basic-Auth': basicAuthToken
                            }
                        });
                        
                        if (response.ok) {
                            await this.loadClinics();
                            await this.syncData();
                        }
                    } catch (err) {
                        console.error('Delete clinic error:', err);
                    }
                },
                
                selectClinicForAppointment(clinic) {
                    this.selectedClinic = clinic;
                    this.showAppointmentDialog = true;
                    this.appointmentSuccess = '';
                    this.appointmentError = '';
                },
                
                async addAppointment() {
                    this.loading = true;
                    this.appointmentSuccess = '';
                    this.appointmentError = '';
                    
                    try {
                        const API_URL = 'https://clinic-note-api.onrender.com';
                        const authToken = localStorage.getItem('authToken');
                        const basicAuthToken = localStorage.getItem('basicAuthToken');
                        
                        const response = await fetch(`${API_URL}/api/appointments`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`,
                                'X-Basic-Auth': basicAuthToken
                            },
                            body: JSON.stringify({
                                clinic_id: this.selectedClinic.id,
                                appointment_date: this.newAppointment.date,
                                appointment_time: this.newAppointment.time || null
                            })
                        });
                        
                        if (response.ok) {
                            this.appointmentSuccess = this.currentLang === 'ja' ? '通院日を追加しました' : 'Appointment added';
                            this.newAppointment = { date: '', time: '' };
                            await this.syncData();
                            
                            setTimeout(() => {
                                this.showAppointmentDialog = false;
                            }, 2000);
                        } else {
                            const errorData = await response.json();
                            this.appointmentError = errorData.message || (this.currentLang === 'ja' ? '追加に失敗しました' : 'Failed to add');
                        }
                    } catch (err) {
                        console.error('Add appointment error:', err);
                        this.appointmentError = this.currentLang === 'ja' ? '追加に失敗しました' : 'Failed to add';
                    } finally {
                        this.loading = false;
                    }
                },
                
                async syncData() {
                    this.syncStatus = 'syncing';
                    
                    try {
                        await this.loadClinics();
                        this.syncStatus = 'synced';
                    } catch (err) {
                        console.error('Sync error:', err);
                        this.syncStatus = 'synced';
                    }
                },
                
                startAutoSync() {
                    this.syncInterval = setInterval(() => {
                        this.syncData();
                    }, 300000);
                },
                
                logout() {
                    if (this.syncInterval) clearInterval(this.syncInterval);
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userId');
                    window.location.href = '/login.html';
                }
            };
        }
    </script>
</body>
</html>
