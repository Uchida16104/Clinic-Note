<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clinic Note - Calendar</title>

<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/light.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/shoelace-autoloader.js"></script>
<script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
<link rel="stylesheet" href="/custom.css">
<style>
@media print {.no-print{display:none}}
</style>
</head>

<body class="bg-gray-100">
<div x-data="calendarData()" x-init="init()" class="container mx-auto p-4">

<h1 class="text-2xl font-bold mb-4">Clinic Note Calendar</h1>

<!-- セレクタ -->
<div class="grid grid-cols-2 gap-4 mb-4 no-print">
<sl-select x-model="selectedHospital" placeholder="Hospital" @sl-change="onHospitalChange()">
<template x-for="h in hospitals"><sl-option :value="h" x-text="h"></sl-option></template>
</sl-select>

<sl-select x-model="selectedDepartment" placeholder="Department" :disabled="!selectedHospital" @sl-change="onDepartmentChange()">
<template x-for="d in departments"><sl-option :value="d" x-text="d"></sl-option></template>
</sl-select>
</div>

<!-- カレンダー -->
<div class="bg-white rounded p-4 shadow">
<div class="flex justify-between mb-2">
<button @click="previousMonth()">‹</button>
<span x-text="currentMonthYear"></span>
<button @click="nextMonth()">›</button>
</div>

<div class="grid grid-cols-7 gap-1 text-center">
<template x-for="d in daysOfWeek"><div class="font-bold" x-text="d"></div></template>

<template x-for="date in calendarDates" :key="date.key">
<div
@click="date.date && selectDate(date)"
class="border p-2 h-16"
:class="{
'bg-gray-200': !date.isCurrentMonth,
'bg-blue-500 text-white': date.isToday,
'cursor-pointer': date.date
}">
<div x-text="date.day"></div>
</div>
</template>
</div>
</div>

<!-- メモ -->
<div x-show="selectedDate" class="bg-white mt-4 p-4 rounded shadow">
<h2 x-text="selectedDateFormatted"></h2>
<sl-textarea x-model="currentMemo"></sl-textarea>
<sl-button @click="saveMemo()">保存</sl-button>
</div>

<!-- ツール -->
<div class="mt-4 no-print flex gap-2">
<sl-button @click="exportJSON()">JSON Export</sl-button>
<sl-button @click="exportCSV()">CSV Export</sl-button>
<input type="file" @change="importJSON($event)" accept=".json">
<input type="file" @change="importCSV($event)" accept=".csv">
<sl-button @click="sendEmail()">Mail</sl-button>
</div>

</div>
<script src="/calendar.js">
<script>
function calendarData(){
return{
API:'https://clinic-note-api.onrender.com',

currentLang:'ja',
daysOfWeek:['日','月','火','水','木','金','土'],
currentDate:new Date(),
calendarDates:[],
currentMonthYear:'',
selectedHospital:'',
selectedDepartment:'',
hospitals:[],
departments:[],
clinics:[],
appointments:[],
memos:[],
doctorMemos:[],
selectedDate:null,
selectedDateFormatted:'',
currentMemo:'',

async init(){
this.restoreState()
await this.loadClinics()
if(this.selectedHospital) this.onHospitalChange()
if(this.selectedDepartment) await this.onDepartmentChange()
this.generateCalendar()
},

saveState(){
localStorage.setItem('clinicState',JSON.stringify({
hospital:this.selectedHospital,
department:this.selectedDepartment,
date:this.currentDate
}))
},

restoreState(){
const s=JSON.parse(localStorage.getItem('clinicState')||'{}')
if(s.hospital) this.selectedHospital=s.hospital
if(s.department) this.selectedDepartment=s.department
if(s.date) this.currentDate=new Date(s.date)
},

async loadClinics(){
const r=await fetch(`${this.API}/api/clinics`,{headers:this.auth()})
this.clinics=await r.json()
this.hospitals=[...new Set(this.clinics.map(c=>c.hospital_name))]
},

onHospitalChange(){
this.departments=this.clinics.filter(c=>c.hospital_name===this.selectedHospital).map(c=>c.department)
this.saveState()
},

async onDepartmentChange(){
await this.loadAppointments()
await this.loadMemos()
this.generateCalendar()
this.saveState()
},

async loadAppointments(){
const c=this.clinics.find(c=>c.hospital_name===this.selectedHospital&&c.department===this.selectedDepartment)
const r=await fetch(`${this.API}/api/appointments?clinic_id=${c.id}`,{headers:this.auth()})
this.appointments=await r.json()
},

async loadMemos(){
const c=this.clinics.find(c=>c.hospital_name===this.selectedHospital&&c.department===this.selectedDepartment)
const r=await fetch(`${this.API}/api/appointments/memos?clinic_id=${c.id}`,{headers:this.auth()})
this.memos=await r.json()
},

generateCalendar(){
const y=this.currentDate.getFullYear()
const m=this.currentDate.getMonth()
this.currentMonthYear=`${y}年${m+1}月`
const start=new Date(y,m,1).getDay()
const days=new Date(y,m+1,0).getDate()
this.calendarDates=[]
for(let i=0;i<start;i++) this.calendarDates.push({key:`e${i}`,day:'',date:null,isCurrentMonth:false})
for(let d=1;d<=days;d++){
const dt=new Date(y,m,d)
this.calendarDates.push({
key:`d${d}`,
day:d,
date:dt,
isCurrentMonth:true,
isToday:dt.toDateString()===new Date().toDateString()
})
}
},

previousMonth(){this.currentDate=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth()-1,1);this.generateCalendar();this.saveState()},
nextMonth(){this.currentDate=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth()+1,1);this.generateCalendar();this.saveState()},

selectDate(d){
this.selectedDate=d.date
this.selectedDateFormatted=d.date.toLocaleDateString('ja-JP')
const m=this.memos.find(m=>m.memo_date===this.formatDate(d.date))
this.currentMemo=m?m.content:''
},

async saveMemo(){
const c=this.clinics.find(c=>c.hospital_name===this.selectedHospital&&c.department===this.selectedDepartment)
await fetch(`${this.API}/api/appointments/memos`,{
method:'POST',
headers:{...this.auth(),'Content-Type':'application/json'},
body:JSON.stringify({clinic_id:c.id,memo_date:this.formatDate(this.selectedDate),content:this.currentMemo})
})
await this.loadMemos()
},

exportJSON(){
const blob=new Blob([JSON.stringify(this.memos,null,2)],{type:'application/json'})
this.download(blob,'memos.json')
},

exportCSV(){
let csv='date,content\n'
this.memos.forEach(m=>csv+=`${m.memo_date},"${m.content.replace(/"/g,'""')}"\n`)
this.download(new Blob([csv],{type:'text/csv'}),'memos.csv')
},

importJSON(e){
const f=e.target.files[0]
f.text().then(t=>JSON.parse(t).forEach(m=>this.memos.push(m)))
},

importCSV(e){
const f=e.target.files[0]
f.text().then(t=>{
t.split('\n').slice(1).forEach(l=>{
const [d,c]=l.split(',')
if(d) this.memos.push({memo_date:d,content:c?.replace(/"/g,'')})
})
})
},

sendEmail(){
this.exportJSON()
window.location.href=`mailto:?subject=Clinic%20Note&body=JSONを添付してください`
},

formatDate(d){return d.toISOString().slice(0,10)},
download(blob,name){
const a=document.createElement('a')
a.href=URL.createObjectURL(blob)
a.download=name
a.click()
},

auth(){
return{
'Authorization':`Bearer ${localStorage.getItem('authToken')}`,
'X-Basic-Auth':localStorage.getItem('basicAuthToken')
}
}
}}
</script>
</body>
</html>
